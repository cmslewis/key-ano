// Generated by CoffeeScript 1.8.0
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  require(['static/js/KeyCodes', 'static/js/PianoKeys'], function(KeyCodes, PianoKeys) {
    var KeyanoInstrument, KeyanoKeyValidator;
    KeyanoKeyValidator = (function() {
      function KeyanoKeyValidator() {}

      KeyanoKeyValidator.prototype.validateKeyMapping = function(keyMapping) {
        if (!_.isObject(keyMapping)) {
          throw new Error("Tried to activate a key using an non-object { keyCode, pianoKey } parameter");
        }
        this._validateKeyCode(keyMapping.keyCode);
        this._validatePianoKey(keyMapping.pianoKey);
      };


      /*
      @params
        keyCode : (integer) the keyboard keyCode that will trigger the piano key
      @throws
        Error if
          - The key code is not an integer
          - The key code value is unrecognized
      @return
        N/A
       */

      KeyanoKeyValidator.prototype._validateKeyCode = function(keyCode) {
        var _ref;
        if (!_.isNumber(keyCode)) {
          throw new Error("Tried to activate a key using a non-integer keyCode");
        }
        if (_ref = !keyCode, __indexOf.call(_.values(KeyCodes), _ref) >= 0) {
          throw new Error("Tried to activate a key using an unrecognized keyCode value");
        }
      };


      /*
      @params
        pianoKey : {
          id        : (string) the unique ID for the piano key
          frequency : (float)  the pitch of the piano key in hertz
        }
      @throws
        Error if
          - The piano key ID is invalid
          - The piano key frequency is invalid
      @return
        N/A
       */

      KeyanoKeyValidator.prototype._validatePianoKey = function(pianoKey) {
        var hasValidFrequency, hasValidId;
        hasValidId = _.isString(pianoKey.id);
        hasValidFrequency = _.isNumber(pianoKey.frequency) && _.isFinite(pianoKey.frequency);
        if (!hasValidId) {
          throw new Error("Tried to register a piano key with an non-string ID: " + pianoKey.id);
        }
        if (!hasValidFrequency) {
          throw new Error("Tried to register a piano key with a non-numeric frequency: " + pianoKey.frequency);
        }
      };

      return KeyanoKeyValidator;

    })();
    KeyanoInstrument = (function() {
      var _audioContext, _keyMappings, _keyValidator, _pianoKeyRegistry, _pitchNodesForActivePianoKeys;

      _audioContext = null;

      _keyMappings = null;

      _keyValidator = null;

      _pianoKeyRegistry = null;

      _pitchNodesForActivePianoKeys = null;

      function KeyanoInstrument() {
        this._activateKey = __bind(this._activateKey, this);
        this._audioContext = new (window.AudioContext || window.webkitAudioContext);
        this._keyMappings = [];
        this._keyValidator = new KeyanoKeyValidator();
        this._pianoKeyRegistry = {};
        this._pitchNodesForActivePianoKeys = {};
      }


      /*
      @params
        keyMappings : (array of objects) [
          {
            keyCode  : (integer) the keyboard keyCode that will trigger the piano key
            pianoKey : {
              id        : (string) the unique ID for the piano key
              frequency : (float)  the pitch of the piano key in hertz
            }
          },
          ...
        ]
       */

      KeyanoInstrument.prototype.activateKeys = function(keyMappings) {
        this._keyMappings = _.flatten([this._keyMappings, keyMappings]);
        _.forEach(keyMappings, this._activateKey);
      };

      KeyanoInstrument.prototype._activateKey = function(keyMapping) {
        var keyCode, pianoKey;
        this._keyValidator.validateKeyMapping(keyMapping);
        keyCode = keyMapping.keyCode, pianoKey = keyMapping.pianoKey;
        $(document).on('keydown', (function(_this) {
          return function(ev) {
            if (ev.keyCode === keyCode) {
              return _this._startPlayingPianoKeyIfNecessary(pianoKey);
            }
          };
        })(this));
        $(document).on('keyup', (function(_this) {
          return function(ev) {
            if (ev.keyCode === keyCode) {
              return _this._stopPlayingPianoKeyIfNecessary(pianoKey);
            }
          };
        })(this));
      };

      KeyanoInstrument.prototype._startPlayingPianoKeyIfNecessary = function(pianoKey) {
        var pitchNode;
        if (this._isPianoKeyPlaying(pianoKey)) {
          console.log('  ', pianoKey.id, ' is already playing, so not playing it');
          return;
        }
        console.log('user pressed the key:', pianoKey.id);
        pitchNode = this._createPitchNodeForPianoKey(pianoKey);
        this._saveActivePianoKeyInstance(pianoKey, pitchNode);
        return pitchNode.start();
      };

      KeyanoInstrument.prototype._stopPlayingPianoKeyIfNecessary = function(pianoKey) {
        var pitchNode;
        if (!this._isPianoKeyPlaying(pianoKey)) {
          console.log('  ', pianoKey.id, ' is not playing, so not stopping it');
          return;
        }
        console.log('user released the key:', pianoKey.id);
        pitchNode = this._getActivePianoKey(pianoKey);
        pitchNode.stop();
        this._deleteActivePianoKeyInstance(pianoKey);
      };

      KeyanoInstrument.prototype._createPitchNodeForPianoKey = function(pianoKey) {
        var oscillatorNode;
        oscillatorNode = this._audioContext.createOscillator();
        oscillatorNode.connect(this._audioContext.destination);
        oscillatorNode.type = 'square';
        oscillatorNode.frequency.value = pianoKey.frequency;
        return oscillatorNode;
      };

      KeyanoInstrument.prototype._isPianoKeyPlaying = function(pianoKey) {
        var pitchNode;
        pitchNode = this._getActivePianoKey(pianoKey);
        return !!pitchNode;
      };

      KeyanoInstrument.prototype._saveActivePianoKeyInstance = function(pianoKey, pitchNode) {
        this._pitchNodesForActivePianoKeys[pianoKey.id] = pitchNode;
      };

      KeyanoInstrument.prototype._deleteActivePianoKeyInstance = function(pianoKey) {
        this._pitchNodesForActivePianoKeys[pianoKey.id] = void 0;
      };

      KeyanoInstrument.prototype._getActivePianoKey = function(pianoKey) {
        return this._pitchNodesForActivePianoKeys[pianoKey.id];
      };

      return KeyanoInstrument;

    })();
    return $(document).ready(function() {
      var keyanoInstrument;
      keyanoInstrument = new KeyanoInstrument();
      return keyanoInstrument.activateKeys([
        {
          keyCode: KeyCodes.A,
          pianoKey: PianoKeys.C3
        }, {
          keyCode: KeyCodes.W,
          pianoKey: PianoKeys.Db3
        }, {
          keyCode: KeyCodes.S,
          pianoKey: PianoKeys.D3
        }, {
          keyCode: KeyCodes.E,
          pianoKey: PianoKeys.Eb3
        }, {
          keyCode: KeyCodes.D,
          pianoKey: PianoKeys.E3
        }, {
          keyCode: KeyCodes.F,
          pianoKey: PianoKeys.F3
        }, {
          keyCode: KeyCodes.T,
          pianoKey: PianoKeys.Gb3
        }, {
          keyCode: KeyCodes.U,
          pianoKey: PianoKeys.Gb3
        }, {
          keyCode: KeyCodes.J,
          pianoKey: PianoKeys.G3
        }, {
          keyCode: KeyCodes.I,
          pianoKey: PianoKeys.Ab3
        }, {
          keyCode: KeyCodes.K,
          pianoKey: PianoKeys.A3
        }, {
          keyCode: KeyCodes.O,
          pianoKey: PianoKeys.Bb3
        }, {
          keyCode: KeyCodes.L,
          pianoKey: PianoKeys.B3
        }, {
          keyCode: KeyCodes.SEMICOLON,
          pianoKey: PianoKeys.C4
        }
      ]);
    });
  });

}).call(this);
